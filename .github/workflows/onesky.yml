name: OneSky Translation PR

on:
  schedule:
    # Run every day at 10:50am UTC (5:50am EST). To avoid delays and possibly dropped jobs GitHub
    # recommends not scheduling jobs at the top of the hour.
    - cron: '50 10 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .tool-versions
      - name: ðŸ“¦ Install Dependencies
        run: yarn install --immutable --immutable-cache
      - name: ðŸŒ Extract Translations
        run: yarn extract
      - name: â›…ðŸ”½ OneSky Download
        env:
          ONESKY_API_KEY: ${{ secrets.ONESKY_API_KEY }}
          ONESKY_API_SECRET: ${{ secrets.ONESKY_API_SECRET }}
          ONESKY_PROJECT_ID: ${{ secrets.ONESKY_PROJECT_ID }}
        run: yarn onesky:download
      - name: ðŸ”€ Create PR
        uses: peter-evans/create-pull-request@v7
        env:
          # Disable git hooks because we are only modifying translation files
          HUSKY: 0
        with:
          branch: bot-update-translations
          add-paths: |
            public/locales/
          # Sign commits so that the author is a bot
          sign-commits: true
          commit-message: Run `yarn extract` and `yarn onesky:download`
          title: '[no-Jira] Update translations'
          body: >
            Update translations with the latest labels extracted from the components and downloaded from OneSky.\n\n
            Due to GitHub Actions restrictions, our `on: pull_request` CI workflow will not run automatically because this PR was created by a bot.
            To get it to run, a human will have to push a commit to the branch.\n\n
            ```sh\n
            $ git switch bot-update-translations\n
            $ git commit --allow-empty --message "Bump CI"\n
            $ git push\n
            ```
